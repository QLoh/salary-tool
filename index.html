<script>
    // 歸級尋找邏輯
    function getLevel(salary, list) {
        if (!list || list.length === 0) return { level: 0, employee: 0, company: 0 };
        for (let i = 0; i < list.length; i++) {
            if (salary <= list[i].level) return list[i];
        }
        return list[list.length - 1]; 
    }

    async function calculate() {
        const salaryInput = document.getElementById("salary").value;
        if (!salaryInput) {
            alert("請輸入薪資");
            return;
        }
        const salary = parseInt(salaryInput);
        const isPartTime = document.querySelector('input[name="empType"]:checked').value === 'part';
        
        try {
            const response = await fetch("grades.json");
            const grades = await response.json();
        
            // 基礎查詢值（全職人員下限 29,500）
            let baseLookup = isPartTime ? salary : Math.max(salary, 29500);

            // 1. 勞保：法定上限 45,800 元
            const labor = getLevel(Math.min(baseLookup, 45800), grades.labor);
            
            // 2. 職保：法定上限 72,800 元
            const job = getLevel(Math.min(baseLookup, 72800), grades.job);
        
            // 3. 健保：法定下限 29,500 元，上限依級距表
            const healthLookup = Math.max(salary, 29500);
            const health = getLevel(healthLookup, grades.health);
        
            // 4. 勞退 6%：依照薪資歸級 (勞退級距最高可達 15 萬級)
            const pension_obj = getLevel(salary, grades.labor);
            const pension_base = pension_obj.level; 
            const pension_fee = Math.round(pension_base * 0.06);

            // 計算總額
            const totalEmp = labor.employee + health.employee;
            const totalComp = labor.company + (job.company || 0) + health.company + pension_fee;

            document.getElementById("output").innerHTML = `
              <div class="section">
                <h4>115年 投保級距明細</h4>
                <ul>
                  <li><span>勞工保險等級：</span><span>${labor.level.toLocaleString()} 元</span></li>
                  <li><span>職災保險等級：</span><span>${job.level.toLocaleString()} 元</span></li>
                  <li><span>全民健保等級：</span><span>${health.level.toLocaleString()} 元</span></li>
                  <li><span>勞退提繳等級：</span><span>${pension_base.toLocaleString()} 元</span></li>
                </ul>
              </div>
              <div class="section">
                <h4>員工負擔額 (個人)</h4>
                <ul>
                  <li><span>勞工保險費：</span><span>${labor.employee.toLocaleString()} 元</span></li>
                  <li><span>全民健保費：</span><span>${health.employee.toLocaleString()} 元</span></li>
                </ul>
                <div class="total"><span>每月自薪資扣除額：</span><span>${totalEmp.toLocaleString()} 元</span></div>
              </div>
              <div class="section">
                <h4>雇主負擔額 (單位)</h4>
                <ul>
                  <li><span>勞工保險費：</span><span>${labor.company.toLocaleString()} 元</span></li>
                  <li><span>職災保險費：</span><span>${(job.company || 0).toLocaleString()} 元</span></li>
                  <li><span>全民健保費：</span><span>${health.company.toLocaleString()} 元</span></li>
                  <li><span>勞退 6% 提繳額：</span><span>${pension_fee.toLocaleString()} 元</span></li>
                </ul>
                <div class="total"><span>雇主法定成本合計：</span><span>${totalComp.toLocaleString()} 元</span></div>
              </div>
            `;
        } catch (error) {
            console.error("Error:", error);
            document.getElementById("output").innerHTML = "<p>❌ 讀取資料失敗，請確認 grades.json 檔案是否存在。</p>";
        }
    }

    function resetCalculator() {
        document.getElementById("salary").value = ''; 
        document.getElementById("output").innerHTML = ''; 
        document.getElementById("salary").focus(); 
    }
</script>
